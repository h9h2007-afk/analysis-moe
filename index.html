<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التحليل الإحصائي الذكية | MOE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --moe-green: #1E5B3C; --moe-light: #2D8A58; --moe-gold: #C5A059; }
        body { font-family: 'Cairo', sans-serif; background: #f4f7f6; overflow-x: hidden; }
        
        /* تأثيرات الواجهة الحديثة */
        .glass-sidebar { background: linear-gradient(180deg, var(--moe-green) 0%, #16432c 100%); }
        .stat-card { background: white; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .stat-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .btn-gold { background: linear-gradient(90deg, #D4AF37 0%, #C5A059 100%); }
        
        /* ضبط الطباعة A4 */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            main { padding: 0 !important; width: 100% !important; }
            .print-only { display: block !important; }
            .card-grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 10px !important; }
            canvas { max-width: 100% !important; height: auto !important; }
        }
    </style>
</head>
<body class="text-slate-700">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <aside class="no-print lg:w-85 glass-sidebar text-white p-6 shadow-2xl flex flex-col space-y-6">
            <div class="text-center py-4 border-b border-white/10">
                <div class="bg-white/10 w-20 h-20 rounded-2xl mx-auto flex items-center justify-center mb-4">
                    <i class="fas fa-chart-line text-3xl text-emerald-400"></i>
                </div>
                <h1 class="text-xl font-black italic">نظام التحليل المتطور</h1>
                <p class="text-[10px] text-moe-gold font-bold tracking-widest">ADVANCED ANALYTICS SYSTEM</p>
            </div>

            <div class="space-y-4 overflow-y-auto pr-2 custom-scrollbar">
                <div>
                    <label class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-1 block">بيانات المؤسسة</label>
                    <input type="text" id="schoolName" placeholder="اسم المدرسة" value="مدرسة زيد بن ثابت الثانوية" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none mb-2">
                    <input type="text" id="subjectName" placeholder="اسم المادة" value="كيمياء" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-1 block">بيانات الكادر</label>
                    <input type="text" id="teacherName" placeholder="اسم المعلم" value="حسن آل هاشم" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none mb-2">
                    <input type="text" id="principalName" placeholder="اسم مدير المدرسة" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-emerald-400 mb-1 block">الدرجة الكبرى</label>
                        <input type="number" id="maxGrade" value="40" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm outline-none">
                    </div>
                    <div class="flex flex-col justify-end">
                        <label class="text-[10px] font-bold text-emerald-400 mb-1 block">رفع الملف</label>
                        <label class="cursor-pointer bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-xl text-center transition">
                            <i class="fas fa-upload text-xs"></i>
                            <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                        </label>
                    </div>
                </div>

                <button onclick="mergeAndAnalyze()" class="w-full py-4 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-white font-black shadow-lg transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-sync-alt"></i> دمج وتحليل البيانات
                </button>
                
                <button onclick="window.print()" class="w-full py-4 rounded-2xl btn-gold text-white font-black shadow-lg hover:brightness-110 transition flex items-center justify-center gap-3">
                    <i class="fas fa-file-pdf"></i> طباعة التقرير الرسمي
                </button>
            </div>
        </aside>

        <main class="flex-1 p-6 lg:p-12">
            
            <div class="hidden print:flex justify-between items-center mb-10 border-b-2 border-moe-green pb-6">
                <div class="text-right">
                    <h2 class="text-2xl font-black text-moe-green" id="p_school"></h2>
                    <p class="text-lg font-bold">المادة: <span id="p_subject"></span></p>
                    <p class="text-sm">معلم المادة: <span id="p_teacher"></span></p>
                </div>
                <div class="text-center">
                    <img src="https://upload.wikimedia.org/wikipedia/ar/thumb/0/03/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg/1200px-Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg.png" class="h-20 mx-auto">
                    <h3 class="font-black mt-2">تقرير تحليل النتائج النهائي</h3>
                </div>
                <div class="text-left text-sm">
                    <p>العام الدراسي: 1447هـ</p>
                    <p>الدرجة الكبرى: <span id="p_max"></span></p>
                    <p>المدير: <span id="p_principal"></span></p>
                </div>
            </div>

            <div class="no-print mb-10 flex justify-between items-end">
                <div>
                    <h2 class="text-4xl font-black text-slate-800">تحليل الأداء</h2>
                    <p class="text-slate-400 font-medium mt-1" id="subTitle">ارفع ملف الإكسل لبدء المعالجة الذكية</p>
                </div>
                <div class="text-left">
                    <span class="bg-emerald-100 text-emerald-700 px-4 py-1 rounded-full text-xs font-black tracking-tighter">LIVE DATA VER 3.0</span>
                </div>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-12 card-grid">
                <div class="stat-card p-6 rounded-3xl border-r-8 border-emerald-800">
                    <i class="fas fa-users text-emerald-800 mb-2 opacity-30"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">إجمالي الطلاب</p>
                    <h3 id="totalStudents" class="text-4xl font-black">0</h3>
                </div>
                <div class="stat-card p-6 rounded-3xl border-r-8 border-emerald-500">
                    <i class="fas fa-star text-emerald-500 mb-2 opacity-30"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">المتوسط العام</p>
                    <h3 id="avgScore" class="text-4xl font-black">0</h3>
                </div>
                <div class="stat-card p-6 rounded-3xl border-r-8 border-blue-600">
                    <i class="fas fa-check-circle text-blue-600 mb-2 opacity-30"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">نسبة النجاح</p>
                    <h3 id="passRate" class="text-4xl font-black">0%</h3>
                </div>
                <div class="stat-card p-6 rounded-3xl border-r-8 border-amber-500">
                    <i class="fas fa-crown text-amber-500 mb-2 opacity-30"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">أعلى درجة</p>
                    <h3 id="maxScore" class="text-4xl font-black">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50">
                    <h4 class="text-sm font-black text-slate-500 mb-8 border-r-4 border-emerald-800 pr-3">توزيع المستويات</h4>
                    <canvas id="gradeChart"></canvas>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 flex flex-col items-center">
                    <h4 class="text-sm font-black text-slate-500 mb-8 w-full border-r-4 border-emerald-500 pr-3">معدل الاجتياز</h4>
                    <div class="w-64"><canvas id="passPieChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 overflow-hidden">
                <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                    <h4 class="font-black text-slate-700">بيانات التقديرات التفصيلية</h4>
                    <i class="fas fa-table text-slate-300"></i>
                </div>
                <table class="w-full text-right">
                    <thead class="text-[10px] font-black uppercase text-slate-400 bg-slate-50">
                        <tr>
                            <th class="px-8 py-4 tracking-widest">التقدير (النطاق)</th>
                            <th class="px-8 py-4 tracking-widest text-center">العدد</th>
                            <th class="px-8 py-4 tracking-widest text-center">النسبة</th>
                        </tr>
                    </thead>
                    <tbody id="resultTable" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>

            <div class="hidden print:grid grid-cols-3 gap-10 mt-16 pt-10 border-t-2 border-slate-100 text-center font-bold">
                <div class="space-y-12">
                    <p>معلم المادة</p>
                    <p id="s_teacher">.......................</p>
                </div>
                <div class="space-y-12">
                    <p>ختم المدرسة الرسمي</p>
                    <div class="w-24 h-24 border-2 border-dashed border-slate-200 rounded-full mx-auto"></div>
                </div>
                <div class="space-y-12">
                    <p>مدير المدرسة</p>
                    <p id="s_principal">.......................</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let workbook, gradeChart, passPieChart;

        function initCharts() {
            const commonOptions = { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } };
            
            gradeChart = new Chart(document.getElementById('gradeChart'), {
                type: 'bar',
                data: {
                    labels: ['ممتاز', 'جيد جداً', 'جيد', 'مقبول', 'لم يجتز'],
                    datasets: [{ data: [0, 0, 0, 0, 0], backgroundColor: ['#1E5B3C', '#22c55e', '#f59e0b', '#3b82f6', '#ef4444'], borderRadius: 12 }]
                },
                options: commonOptions
            });

            passPieChart = new Chart(document.getElementById('passPieChart'), {
                type: 'doughnut',
                data: { labels: ['اجتياز', 'رسوب'], datasets: [{ data: [1, 0], backgroundColor: ['#22c55e', '#f1f5f9'], borderWidth: 0 }] },
                options: { cutout: '85%' }
            });
        }

        document.getElementById('excelInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => { 
                workbook = XLSX.read(evt.target.result, { type: 'binary' }); 
                alert("تم تحميل الملف بنجاح! اضغط على دمج وتحليل البيانات.");
            };
            reader.readAsBinaryString(e.target.files[0]);
        });

        function mergeAndAnalyze() {
            if (!workbook) return alert("الرجاء اختيار ملف أولاً");
            const max = parseFloat(document.getElementById('maxGrade').value);
            let allScores = [];

            workbook.SheetNames.forEach(name => {
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 });
                rows.forEach((row, i) => { if(i!==0 && !isNaN(row[1])) allScores.push(parseFloat(row[1])); });
            });

            const total = allScores.length;
            const avg = (allScores.reduce((a,b)=>a+b,0)/total).toFixed(1);
            let counts = [0,0,0,0,0]; let passed = 0;

            allScores.forEach(s => {
                const p = (s/max)*100;
                if(p>=90) counts[0]++; else if(p>=80) counts[1]++; else if(p>=70) counts[2]++; else if(p>=50) counts[3]++; else counts[4]++;
                if(s >= max*0.5) passed++;
            });

            // Update UI
            document.getElementById('totalStudents').innerText = total;
            document.getElementById('avgScore').innerText = avg;
            document.getElementById('passRate').innerText = ((passed/total)*100).toFixed(0) + "%";
            document.getElementById('maxScore').innerText = Math.max(...allScores);
            document.getElementById('subTitle').innerText = `تم تحليل ${total} طالب من كافة الفصول`;

            gradeChart.data.datasets[0].data = counts; gradeChart.update();
            passPieChart.data.datasets[0].data = [passed, total-passed]; passPieChart.update();

            // Print Sync
            document.getElementById('p_school').innerText = document.getElementById('schoolName').value;
            document.getElementById('p_subject').innerText = document.getElementById('subjectName').value;
            document.getElementById('p_teacher').innerText = document.getElementById('teacherName').value;
            document.getElementById('p_principal').innerText = document.getElementById('principalName').value;
            document.getElementById('p_max').innerText = max;
            document.getElementById('s_teacher').innerText = document.getElementById('teacherName').value;
            document.getElementById('s_principal').innerText = document.getElementById('principalName').value;

            const labels = ['ممتاز (90%+)', 'جيد جداً (80%+)', 'جيد (70%+)', 'مقبول (50%+)', 'لم يجتز'];
            document.getElementById('resultTable').innerHTML = counts.map((c, i) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-8 py-5 font-bold text-slate-700">${labels[i]}</td>
                    <td class="px-8 py-5 text-center font-black text-emerald-700">${c}</td>
                    <td class="px-8 py-5 text-center font-mono text-slate-400">${((c/total)*100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        window.onload = initCharts;
    </script>
</body>
</html>
